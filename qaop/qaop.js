// Qaop/JS Copyright by Jan Bobrowski 2011-2023
((u,S1)=>{var l="/qaop/",v=this;const x=0,T1=1,_=2,M=3,o=13,O=27,R=38,j=40,D=46,f=setTimeout,h=e=>u.querySelector(e),J=(e,r)=>[...(r?e:u).querySelectorAll(r||e)],y=e=>u.createElement(e),Z=e=>e.parentNode,c=(e,r)=>e.matches&&e.matches(r),q=e=>e.preventDefault(),$1=e=>new Uint8Array(e);var K=[];function W(e,r){var n=e.stack;n&&console.error(n),(n=e.message)&&(e=n);const a=()=>{var[e,r]=K[0],n=h("#m");n.className="v",n.textContent=e,f(()=>{n.className="",f(()=>{K.shift(),K[0]&&a()},99)},r)};K.push([e+="",r||3e3+9*e.length])<2&&a()}var z,p,S,t,b,B,k,n,i,X,H,w,a,Y,d,m,s,g,T,G,P,Q,$,V,e1,r1,n1,a1,i1,t1,C,U,A,o1,L,u1,f1,c1,s1,l1,E,F,v1=[];function d1(e){var r,n=h("#pb"),a=("string"==typeof e?n.style.color=e:e&&v1.indexOf(e)<0&&v1.push(e),0),i=0;for(e of v1)r|=!e.e,a+=0|e.b,i+=0|e.t;r=r?(n.firstChild.style.width=100*(i?a/i:0)+"%",a&&i?"v":"v a"):(v1=[],""),n.className=r}function m1(c,a,e){var s=!a.nopb;if(c.data)return c.eof=1,d();var r,l,n=c.file;function v(e,r){c.eof=l.e=1,l.t=l.b=e,s&&d1(l),r&&(c.data=null,W(r)),d()}function d(){e&&e(c)}function i(e){v(1,e||"Error")}n?(c.type||(c.type=n.type),c.name||(c.name=n.name),(r=new FileReader).readAsArrayBuffer(n),r.onloadend=()=>{c.data=$1(r.result),c.eof=1,d()}):(l={},n={},a.acc&&(n.headers={Accept:a.acc}),fetch(c.url,n).then(e=>{if(c.type=c.type||e.headers.get("Content-Type"),e.status&&200!=e.status)return i(e.statusText);c.url=e.url;var r,u=+e.headers.get("Content-Length");if(l.t=u,l.b=0,a.text)e.text().then(e=>{c.data=e,v(e.length)});else{if(e.body)return r=e.body.getReader(),f();e.arrayBuffer().then(e=>{e=$1(e),c.data=e,v(e.length)})}function f(){return r.read().then(n)}function n(e){var r,n,a,i,t,o=e.done,e=e.value;if(e&&(l.b+=e.length,e=e,r=c.data,n=c.pos,r&&(i=(a=r.length)-n)&&((t=$1(i+e.length)).set(r.slice(n,n+a)),t.set(e,i),e=t),c.data=e,c.pos=0,s)&&(l.t=l.b<u?u:l.b+9999,d1(l)),!o)return d(),f();v(l.b)}}).catch(e=>i(e)))}function p1(e,a){var i=y("img");i.src=e,i.onload=()=>{var e=y("canvas"),{width:r,height:n}=i,e=(e.width=r,e.height=n,e.getContext("2d"));e.drawImage(i,0,0),a(e,r,n)}}function b1(e){var r,n=z.keyboard;192&e&&(n[0]=-2&n[0]|1&(r=e>>6^3),n[7]=-3&n[7]|2&r),n[7&e]&=~(1<<(e>>3&7))}function k1(e){var r=S.zx.devs,n=r.indexOf(B),a=0<=n;return e!=S1&&a^!!e&&(e?(p=0,r.push(B)):(p=S1,r.splice(n,1))),a}function h1(e){if(w)z.frame(e),w1();else{for(var r=n;r--;)k&&k(),z.frame(r?1:5|e);S.tape&&w1()}y1()}function y1(){var e,r,n,a=z.updated;a&&(z.updated=0,[a,e,r,n]=a,r-=a,a*=i,r*=i,H.putImageData(X,0,0,n,a,e-=n,r))}function w1(){var r,e,n,a=w;if(1&(i=z.cpu.getState()).iff||(e=i.pc)<1387||1540<e)w=null;else{var i=z.getState(2),t=[z.v[0],i.ram[5],i.ram[2],i.ram[7&i.p7FFD]];if(a)r=a.pos,n=a.data.length;else{if(16&~i.p7FFD)return;if((e=1507<=e&&1510==(e=p())?p():e)<1387||1403<=e)return;if(a=S.tape,n=a.data.length,a.blk|=0,a.eof&&a.blk>=n&&(a.blk=0),(r=a.blk+2)<=n)a.blk=r+(m(r-2)|m(r-1)<<8);else if(!a.eof)return;w=a,i.a=i.a_,i.f=i.f_,i.pc=e,i.hl&=255}for(var o,u,f=255&i.hl,c=i.hl>>8&255,{ix:s,a:l,f:v}=i;;){if(r==a.blk)return d(80);if(n<=r){if(a.eof)return d(80);break}if(f=m(r++),c^=f,!i.de)return d((l=c)<1|l-1&128|!(l-1)<<6|!(15&l)<<4|2);if(64&~v){if(l^=f)return d(0);v|=64}else{if(1&v)o=s,u=f,16383<(o&=65535)&&(t[o>>14][16383&o]=u);else if(l=b(s)^f)return d(0);s=s+1&65535,i.de--}}d(-1)}function d(e){i.ix=s,i.hl=c<<8|f,i.a=l,0<=e&&(v=e,i.pc=p(),w=null,e=S.next_tape)&&a.eof&&r==n&&(S.tape=e),i.f=v,z.setState(i),a.pos=r}function m(e){return a.data[e]}function p(){var e=i.sp;return i.sp=e+2&65535,b(e)|b(e+1&65535)<<8}function b(e){return t[e>>14][16383&e]}}function g1(e,r,n){if(n&&Y[e]&&Y[e].abort(),Y[e]=r)switch(e){case"tape":w=null;break;case"snap":S.stop(e,0)}}function x1(e,r){var n;if(e=e.toLowerCase(),r)e=(n=(n=e.replace(/\?.*/,"").match(/\S\.(\w{3})$/))||e.match(/\S\.(\w{3})$/))&&n[1];else if(3<e.length&&(e=(n=e.match(/^(application|image)\/(x\.zx\.|x-spectrum-)([-.a-z0-9]+)/))&&n[3])&&"i"==n[1][0]&&"scr"!=e)return;if((e="slt"==e?"z80":e)&&~["rom","sna","z80","tap","scr"].indexOf(e))return e}function _1(n){var a;if([/^(48k?|0)$/i,/^1(28k?)?$/i,/^((tc)?2(048|k)|2)$/i,/^(p|3$)/i].find((e,r)=>{e=e.test(n);return e&&(a=r),e}))return a}function z1(e){return(1<<T1|1<<M)>>e&1}function C1(e){g&&top.postMessage(e,"*")}function U1(){var{model:e,ay:r,kj:n}=emu.getState();function a(e,r,n){for(var a of J(`[data-c="${e}"]`))n?a.value=r:a.classList.toggle("active",!!r)}I(s,"pause",C),a("pause",C),a("model",e==M?T1:e,1),a("mute",U),a("ay",r),a("kj",n),h("#vol>*>*").style.width=100*A+"%"}function N(e){var r,n=e.model;n!=S1&&(e.model=_1(n)),emu.setState(e),(n=e.volume)!=S1&&(A=0<n?1<n?1:n:0,r=1),(n=e.mute)!=S1&&(U=!!n,r=1),r&&emu.zx.volume(U?0:A),U1(),C1(e)}function A1(){var e,r=3&$,[n,a]=emu.zx.dim,i=innerWidth,t=innerHeight,o=i,u=t,f=(0<(c=512-o)&&(o+=c>>3),0),c=(r&&(o=15*o>>4,f=u>>5,e=t-(u=15*u>>4)>>2),n*u),s=((d=a*o)<c?u-=u-d/n|0:o-=o-c/a|0,i-o>>1),l=G.canvas_w,v=P.canvas_w,d=i-48;switch(r){case 1:s<(c=(l=d<l?d:l)+e)&&(s=c);break;case 2:(c=i-o-(v=d<v?d:v)-e)<s&&(s=c);break;case 3:(d>>=1)<l&&(l=d),d<v&&(v=d)}var n=h("#c").style,m=(n.width=o+"px",n.height=u+"px",n.left=s+"px",n.top=f+"px",(n=G.e.style).left=(1&r?0:-G.w)+"px",n.width=l+"px",(n=P.e.style).right=(2&r?0:-P.w)+"px",n.width=v+"px",emu.canvas(T,u),h("#k")),a=m.style,f=t-u,n=!r&&127<f;if(V=e1=0,n){var p=0;do{var b,k=m.children[p]}while(k||(k=m.appendChild(y("div"))," "==(b="1234567890QWERTYUIOPASDFGHJKL  ZXCVBNM  "[p])&&(b={29:"Enter",30:"Caps Shift",38:"Symbol Shift",39:"Space"}[p],k.className="t"),k.textContent=b),++p<40);a.top=u+"px";t=i>>1;a.height=(t=f<t?f:t)+"px",e1=(V=u)+t}a.display=n?"flex":"none"}function L1(e){emu.m&&emu.m();var r,n=e.target;if(a=n.closest("[data-c]"))return r=a.dataset.c,a.disabled?void 0:"SELECT"!=n.nodeName?void ui.cmd(r):void("l"!=e.type[1]&&ui.cmd(r,a.value));if(c(n,"#s,button"))(n="s"==n.id?h("#c"):n).focus();else{if(h("#vol").contains(n))return G1(e);var a=u.activeElement;a5(e,t1!=a&&"click+focus"),t1=a}}function E1(n){var{type:e,target:a}=n;if("m"==e[0]){if("d"==e[5])return r1=a,R1(),t1=u.activeElement,h("#vol").contains(n.target)?G1(n):void 0;if("o"==e[5])return void(n.relatedTarget==S1&&clearTimeout(i1));"u"==e[5]&&(r1=S1,R1())}var i,r,t,o=[n.pageX,n.pageY];return n1?n1(n,e,o):(i=a1,a1=o,"m"!=e[0]&&(r=I1(n)),(!i||(t=o[0]-i[0])||o[1]-i[1])&&(I(s,"+move"),clearTimeout(i1),i1=f(()=>{if(I(s,"-move"),i){if(c(a,".tabv>button"))return a.focus();var e,r;a5(n,"hover")||([r,e]=i,e<32)||V<=e&&e<e1||(r=i[0],t<=0&&r<32&&ui.show(1,1),0<=t&&innerWidth-r<33&&ui.show(2,2))}},200)),r)}function F1(e){var r,n,{target:a,type:i,keyCode:t,ctrlKey:o,altKey:u,metaKey:f}=e,i="d"==i[3],c=emu.stop("user"),u=u|f;if(!u&&o&&(u=2),i){(r={33:1,34:-1,38:1,40:-1,112:"help",113:"remember",114:"restore",116:"update",118:"bw",121:"mute"}[t])||2!=u||(r={79:"open",83:"save"}[t]);let e={19:2,27:1,32:1}[t];if(e&&(1<e||!$&&c)&&(r="pause"),t!=O&&120!=t||(n=$,ui.show(3,t==O?0:3^$&&3)),t!=D||$||(r="reset"),45!=t||g||h("[rel=search]").click(),"BUTTON"==a.nodeName)if(37==t||39==t){for(e=37==t?"previous":"next";(a=a[e+"ElementSibling"])&&a.hidden;);a&&"BUTTON"==a.nodeName&&a.focus()}else t==j&&(e=a.dataset.down)&&h("#"+e).focus()}119==t&&((f=h("#kh")).children[0]||((o=new Image).src=l+"keyboard#qaop",f.appendChild(o)),f.style.display=i?"block":"",emu.stop("kh",i)),r===+r&&((t<R||"vol"==a.id)&&N({volume:A+.1*r}),r=0),r&&(t==D&&emu.kbd(),(r=g&&116==t?0:r)&&ui.cmd(r),n=1),$||n||c||(20==t?(emu.zx.getState().ram[5][7274]>>3&1^e.getModifierState("CapsLock")||!i)&&emu.kbd(75,i,0):n=!emu.kbd(~t,i,e.shiftKey|2*!!u)),n&&q(e),a5(e)}function N1(e){var r=e.target;if(r!=v)return e="focus"==e.type,"c"==r.id?e?void ui.show(3,0):(emu.kbd(),void f(()=>{u.activeElement==r||$||ui.show(3,3)})):void(e&&(c(r,"#l *")&&ui.show(1,1),c(r,"#r *")&&ui.show(2,2),c(r,".tabv>button"))&&P1(r))}function I1(e){var r=e.type,n=e.dataTransfer||e.clipboardData;if(n.dropEffect="copy",q(e),"drop"!=r&&"paste"!=r)return!1;(e=(e=n.files)&&e[0]||n.getData("URL"))?ui.load(e):(e=n.getData("Text"))&&emu.kbd(e)}function M1(e){var r,n,{type:a,target:i}=e,t=e.dataTransfer||e.clipboardData;return h("#c").contains(i)?("dragstart"!=a&&"copy"!=a||(Y1(t),i=y("canvas"),a=y("img"),r=emu.zx.dim,i.height=n=r[1]>>1,i.width=r=r[0]>>1,i.getContext("2d").drawImage(T,0,0,T.width,T.height,0,0,r,n),a.src=i.toDataURL(),t.setDragImage(a,r/2,n/2)),!0):a5(e)}function O1(e){o1=[...e.touches],R1();var r=e.type[5];"m"==r&&q(e),"e"==r&&emu.m&&emu.m()}function R1(){var e,r=o1.map(e=>e.target),n=(r1&&(r=r.slice()).push(r1),J("#k>*"));for(e of r)~(a=n.indexOf(e))&&(L[a]||ui.cmd("pause",!1),L[a]=2);for(var a=0;a<40;a++){var i,t,o=L[a];o&&(t=a-10*(i=a/10|0),o--,emu.kbd(t<5?3-i|t<<3:4+i|9-t<<3,o),I(n[a],"p",o),L[a]=o)}}function j1(e){var r=d.hash.slice(1),n=(!r&&v._load&&(r="!"+_load),h("#bb"));if(e||r!=n.value){n.value=r;var a,i,t=decodeURIComponent,o={},e=r.match(/^!([^#]+)#?(.*)/);e&&(o["!"]=t(e[1]),r=e[2]);for(a of r.split(/#/))a&&((i=a.match(/^(~?)([^=./]+)(?:=([^#]*))?$/))?o[i[2]]=!i[1]&&(null==i[3]||t(i[3])):o.l||(o.l=a));return o}}function D1(e){if(e){var r,n,a,c,s,i,t,o,u=l1,f=(u.u!=e.u&&(u.u=t=e.u,(r=h("[data-for=userg]")).hidden=!t,a=t||null,(s=V1("user")).rq&&s.rq.abort(),null!=a&&(s.act=Q1,(c=y("a")).href=a,s.rq=m1({url:c.href},{text:1,acc:Q+",text/plain,text/html",color:"#EC0"},e=>{if(e.eof){delete s.rq,s.ul.innerHTML="";var{type:r,data:n}=e;if(n){var a,r=r&&r.replace(/ *;.*/,""),i=h("head"),t=y("base");t.href=e.url,i.insertBefore(t,i.firstChild);try{if(r==Q){if(!(a=JSON.parse(n)).forEach)throw"Not a table"}else a=(a="text/html"==r?((a=y("div")).innerHTML=n,J(a,"a:not([rel=up])").map(e=>({url:e.href,name:e.textContent}))):n.split(/\n+/).map(e=>{e=e.match(/^(\S+)\s*(.*)/);if(e)return{url:e[1],name:e[2]||e[1]}})).filter(e=>{if(e&&e.url)return e.name||(e.name=e.url.replace(/.*\//,"")),e});for(var o of a){var{name:u,url:f}=o;u&&f&&(c.href=f,f=c.href,r5(s,u+"",{url:f}))}}catch(e){ui.msg(e)}i.removeChild(t)}}}),s.ul.innerHTML="\u2652"),t)&&r.focus(),(t=e["!"])&&(o=t.match(/^([a-z0-9]+)(:[a-z0-9]+)?$/))?(u.l=null,ui.load(l+"bin/"+t,1),E.hasOwnProperty(t)?Z1():(E[o[1]]=null,m1({url:l+"inf/"+o[1]},{text:1,acc:Q,nopb:1},e=>{var r,e=e.data;e&&(r=(e=JSON.parse(e)).id)&&(E[r]=e,Z1())}))):u.l!=e.l&&(u.l=n=e.l),{});for(i of[48,128,"tc2048","ay","kj","speed"])(t=e[i])!=S1&&((o={48:x,128:T1,tc2048:_}[i])==S1?f[i]=!!t:f.model=t?o:x);N(f),e.reset&&emu.reset(),n&&ui.load(n)}}function J1(e){var r=d.href.replace(/#.*/,"");(e||/^#!/).test(d.hash)&&history.replaceState(null,null,r),onhashchange()}function Z1(){var e=d.hash.match(/^#!([a-z0-9]+)/),r=f1,n=c1,a=h("link[rel=manifest]");e&&(r=r||(f1=u.title),!n&&a&&(n=c1=a.href),e=E[e[1]])&&(r=e.name+" \u2022 ZX Spectrum online",n=l+"wam/"+e.id),r&&(u.title=r),n&&a&&(a.href=n)}function q1(){for(var e,n=V1("snaps"),r=[],a=n.o.slice(),i=0;i<m.length;i++)/^zx\/./.test(e=m.key(i))&&r.push(e.slice(3));r.sort(),r=r.filter(e=>{e=a.indexOf(e);if(e<0)return 1;delete a[e]}),a.forEach((e,r)=>n5(n,r)),r.forEach(e=>r5(n,e,e)),n.act=B1}function K1(e,r){var n=h("#save");n.href=r,n.textContent=n.download=e,n.click()}function W1(){h("[data-c=restore]").disabled=!F.snaps.o.length}function B1(e,r,n){var a=this,i=a.o.length;switch(e){case"click":n||h("#c").focus();case"drag":var t=a.o[r]||a.o[i-1],o=t&&m["zx/"+t];if(t&&o){if("drag"==e)return Y1(n,t,o);ui.load(o)}break;case"sel":h("[data-c=svsna]").disabled=h("[data-c=rmsna]").disabled=r<0,0<=r&&i5(a.e[r]);break;case"del":0<=r&&(m.removeItem("zx/"+a.o[r]),n5(a,r),W1())}}function X1(){var e=new Date;return[e.getMonth()+1,e.getDate(),e.getHours(),e.getMinutes()].reduce((e,r,n)=>e+"-- :"[n]+("0"+r).substr(-2),e.getFullYear())}function H1(e){return"data:application/x.zx.z80;base64,"+btoa(function(n){var e,r,a=[],i={a:0,f:1,bc:2,hl:4,pc:32,sp:8,i:10,r:11,de:13,bc_:15,de_:17,hl_:19,a_:21,f_:22,iy:23,ix:25};for(r in i){var t=i[r];a[t]=255&n[r],r.match(/.[a-z]/)&&(a[t+1]=n[r]>>8)}if(a[12]=n.r>>7&1|n.border<<1|32,e=n.iff,a[27]=1&e,a[28]=2&e&&(n.halted?118:1),a[29]=n.im|!!n.kj<<6,a[34]=[0,3,14,9][n.model],a[35]=n.p7FFD,a[36]=0|n.pFF,e=3,n.ay){for(a[38]=n.ay.idx,e=0;e<16;e++)a[39+e]=n.ay.reg[e];e=7}a[37]=e,a.length=32+(a[30]=23);var f=String.fromCharCode,c=f(...a);if(z1(n.model)){var o=5|n.p7FFD>>2&2;s(3+o,o);for(var u=0;u<8;u++)u!=o&&s(u+3,u)}else s(8,5),s(4,2),s(5,0);return(a=n.rom)&&l(1,a,0),c;function s(e,r){l(e,n.ram[r],0)}function l(e,r,n){var a=n+16384,i="";do{for(var t=r[n],o=1;r[++n]===t&&o<255;)o++;var u=f(t);if(4<o||237==t&&1<o)i+="\xed\xed"+f(o)+u;else{for(;i+=u,--o;);237==t&&n<a&&(i+=f(r[n++]))}}while(n<a);o=i.length,c+=f(255&o,o>>8,e)+i}}(e||emu.getState()))}function Y1(e,r,n,a,i){if(n=n||H1(),e.setData("URL",n),!a){if(!(a=n.match(/^data:([^,;]+)/)))return;a=a[1]}(i=i||emu.getType(a))&&(r=(r||X1())+"."+i,e.setData("DownloadURL",`${a}:${r.replace(/:/g,"")}:`+n))}function G1(e){var i,r,{type:e,pageX:t}=e;const o=e=>{var r=h("#vol>*").getBoundingClientRect();N({volume:(e-r.left)/r.width})};switch(e[0]){case"m":if(r=h("#vol>*>*>*").getBoundingClientRect(),(t-=r.left)<0||t>=r.width)return;t-=r.width/2,n1=(e,r,n)=>{var a;o(n[0]-t),i=1,"mouseup"==r&&(i&&(a=onclick,onclick=null,f(()=>onclick=a)),n1=null)};break;case"c":o(t)}return i}function P1(e){for(var r of Z(e).children){var n=r.getAttribute("data-for"),a=r==e;I(r,"active",a),r.tabIndex=a-1,n&&(h("#"+n).style.visibility=a?"visible":"hidden")}}function Q1(e,r){"click"==e&&(h("#bb").value="",(e=this.o[r]).id?(d.hash="#!"+e.id,onhashchange()):ui.load(e.url),h("#c").focus())}function V1(e){e=F[e];return e.e=[],e.o=[],e.sel=-1,e.ul.innerHTML="",e}function e5(e,n){0<=n&&i5(e.e[n]),e.e.forEach((e,r)=>I(e,"sel",r==n)),e.act("sel",e.sel=n)}function r5(e,r,n){var a=y("li"),i=a.appendChild(y("a"));return i.textContent=r,e.ul.appendChild(a),e.e.push(a),i.draggable=!0,e.o.push(n)-1}function n5(e,r){e.ul.removeChild(e.e[r]),e.e.splice(r,1),e.o.splice(r,1);var n=e.sel;e5(e,n-=r<n||n==r&&r==e.e.length)}function a5(e,r){var n=function(e){var r,n,a;for(a in c(e,".ls>li>a")?e=Z(r=Z(n=e)):c(e,".ls>li")&&(e=Z(e)),F){var i=F[a];if(i.ul==e)return{l:i,i:i.e.indexOf(r),e:r,a:n}}}(e.target);if(n){var{l:a,i}=n,t=a.sel;switch(r||e.type){case"click":t=i;case"click+focus":0<=i&&!(1<e.which)&&a.act("click",i,e.ctrlKey);break;case"hover":0<=i&&(t=i);break;case"keydown":switch(e.keyCode){case R:t-=0<t;break;case j:t+=t+1<a.e.length;break;case o:0<=t&&a.act("click",t,e.ctrlKey);break;case D:return a.act("del",t),1;case O:t=-1;break;default:return void a.act("key",-1,e)}q(e);break;case"dragstart":(t=i)<0||a.act("drag",i,e.dataTransfer)}return a.sel!=t&&e5(a,t),1}}function i5(e){var r=u.activeElement,n=e.scrollIntoViewIfNeeded;if(n)return n.call(e);r==e?r.blur():(e.focus(),u.activeElement!=e&&(e.tabIndex=-1,e.focus(),delete e.tabIndex,e.removeAttribute("tabindex"))),r.focus()}function I(e,r,n){do{var[,a,i,r]=r=r.match(/([-+])?(\S+)\s*(.*)/)}while(e.classList.toggle(i,a?"+"==a:n),r)}function t5(e){var l=this;l.cpu=new e(l),l.devs=[],l.keyboard=$1(8).fill(255),l.updated=0;const Z=1,f=4,c=8,s=16,q=[{p:c|s,k:[69888,14335,224,32]},{p:Z|c|s,k:[70908,14361,228,32]},{p:f|c,k:[69888,14320,224,32]},{p:Z,k:[71680,17985,224,36]}];var v,d,K,o,m,p,b,k,W,h,y,w,g=c|s;function r(e){var r,n,a,i,t,o=e.pFE,u=16384;if(o!=S1&&(_=o),o=e.border,a=7&((r=_)^(_=o!=S1?-8&r|o:_)),"rom"in e&&(h=e.rom),o=e.model,(r=e.p7FFD)!=+r&&(r=z),o!=S1&&(3<o>>>0&&(o=T1),W=l.v[o],t=q[o],g=t.p,v=t.k,d=v[2],K=191*d+126,~g&Z)&&(b!=k[0]&&x(k[0]=$1(u),0,b,0,u),r=48),a|=8&(r^z),X(r),(o=(o=e.pFF)!=S1||!t||g&f?o:0)==(0|o)&&(S=o,V(),a=1),o=P(),I!=o&&(I=o,a=1),(o=e.cont)!=S1&&(g&=~c,y&=-16,o)&&(g|=c,y|=2|(1&z)<<3),(o=e.fbus)!=S1&&(g=o?g|s:g&~s),o=e.ram)if(a=1,8<(n=o.length))x(m,0,o,0,u),x(p,0,o,u,u),x(b,0,o,32768,u);else for(;n;)(i=o[--n])&&k[n]!=i&&x(k[n],0,i,0,u);if(""===(o=(o=e.ay)==S1?e.model:o)&&(o=!!J,J=S1),o!=S1)if(o){if(J||(J={idx:0,reg:[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],volt:[0],avol:0,bvol:0,cvol:0,mix:0,gen:0,aper:0,bper:0,cper:0,nper:0,eper:0,dis:0,ech:0,ekeep:0,ealt:0,eattack:0,estep:0,ecnt:0,noise:1},g1()),o.reg)for(r=0;r<15;r++)o.reg[r]!=S1&&x1(r,0|o.reg[r]);(r=o.idx)!=S1&&(J.idx=15&r)}else J=S1;(o=e.time)==+o&&(l.time=o-v[1]),l.cpu.setState(e),a&&j&&(t=l.time,B(2),l.time=t)}function x(e,r,n,a,i){e.set(n.slice(a,a+i),r)}function B(e){M=(1&S)<<13,e1=0,n1=E*i1,r1=E*(L+32+L)+L-1,o1=-L,u1=-E;var r=t1=-d*E-4*L+4,n=(2&e&&(O(a=l.time),f1(a)),v[0]-v[1]),a=(1&e?(g&f&&64&S||(l.int=255,l.time_limit=v[3]-v[1],l.cpu.run()),l.int=-1,l.time_limit=n,l.cpu.run()):l.time=n,l.time);l.time-=v[0],2&e&&(O(a),I!=Q)&&(n=t1,f1(a),n==r)&&(Q=I)}l.init=()=>{C=new Int32Array(256),n=new Int32Array(256);for(var e=0;e<256;e++)C[e]=(e<<1&240|e>>3&8|7&e)<<8;for(C[64]=C[192]=0,U=C,A=new Int32Array(F*N/8),k=[],e=0;e<8;e++)k[e]=$1(16384);m=k[5],p=k[2],b=k[0],y=226,(w=m).fill(7,6144,6912),r({model:0}),l.time=-v[1]},l.reset=()=>{l.cpu.reset(),X(g&Z?0:48);var e,r=l.time;for(e of l.devs)e.reset&&e.reset(r);I=U[0]},l.getState=r=>{var n,e=l.cpu.getState(),a=(e.pFE=_,e.border=7&_,e.p7FFD=z,e.model=q.map(e=>e.k).indexOf(v),e.cont=!!(g&c),e.fbus=!!(g&s),e.pFF=S,e.ay=J&&{idx:J.idx,reg:J.reg.slice()},e.time=l.time+v[1],e.frt=v[0],16384);if(1==r)x(n=$1(3*a),0,m,0,a),x(n,a,p,0,a),x(n,32768,b,0,a);else{n=[];for(let e=0;e<8;e++)n[e]=k[e],1<r&&x(n[e]=$1(a),0,k[e],0,a)}return e.ram=n,h&&(e.rom=h),e},l.setState=r,l.frame=e=>{if(!--Y){Y=16;for(var r=128;r<256;r++){var n=C[r];C[r]=n<<4&61440|n>>4&3840}}var a,i=v[0],t=l.time;for(a of l.devs)a.frame&&a.frame(i,t,e);v1=50*i,B(e),D&&(y1(i+t),p1=t)},l.time=l.time_limit=0,l.m1=(e,r)=>{var n,a;if(e<32768)if(e<16384){for(var i of l.devs)if(i.m1){i=i.m1(e);if(i!=S1){h=i||S1,o=i||(16&z?W:l.h);break}}n=o,a=1}else n=m,a=2;else a=e<49152?(n=p,4):(n=b,8);var t=l.time-u;return 0<t&&$(t),y&a&&T(0),u=y&1<<(r>>14)?l.time+4:99999,n[16383&e]},l.get=e=>{var r,n=e<32768?e<16384?(r=o,1):(r=m,2):e<49152?(r=p,4):(r=b,8),a=l.time-u;return 0<a&&$(a),u=99999,y&n&&(T(0),u=l.time+3),r[16383&e]},l.put=(e,r)=>{var n,a=y,i=(e<32768?e<16384?(n=o,a&=17):(n=m,a&=34):e<49152?(n=p,a&=68):(n=b,a&=136),l.time-u);0<i&&$(i),u=99999,a&&(15&a&&(T(0),u=l.time+3),n[e&=16383]!==r)&&(n===w&&O(l.time),n[e]=r)},l.get16=e=>{var r,n,a=16383&e;return 16383==a?(n=l.get(e),l.time+=3,n|=l.get(e+1&65535)<<8,l.time-=3,n):(n=e<32768?e<16384?(r=o,1):(r=m,2):e<49152?(r=p,4):(r=b,8),0<(e=l.time-u)&&$(e),u=99999,y&n&&(T(0),T(3),u=l.time+6),r[a]|r[1+a]<<8)};var u,_=0,z=48,S=0;function X(e){b=k[7&(z=e)],y=g&c?226|e<<3&8:224,w=k[5|e>>2&2],o=h||(16&e?W:l.h)}function T(e){(e+=l.time)<0||K<=e||(e%=d)<126&&0<(e=6-(7&e))&&(l.time+=e)}function $(e){var r=u;if(!(r+e<=0)){var n,a=K-r;if(!(a<0)){if(126<(a%=d)){if((e-=a-126)<=0)return;r=6,n=15}else{if(n=a>>3,7==(a&=7)&&(a--,!--e))return;r=a}n<(e=e-1>>1)&&(e=n),l.time+=r+6*e}}}function H(e){var r=l.time-u,n=1&e;0<r&&$(r),u=~g&c?99999:e>>14^1?(n||T(1),99999):(u=l.time,$(1+n<<1),l.time+4)}l.inp=e=>{H(e);var r,n,a,i,t=65535,o=l.time;for(r of l.devs)(e&r.imask)==r.iport&&(t&=r.inp(e,o));return t<256||(i=255,1&~e?(i=_<<2&64|160&i|31,i&=function(e){var r=l.keyboard,n=255;if(e){for(var a=0;255==r[a];)if(8==++a)return n;for(var i=a;i<8;i++){var t=r[i];n&~t&&(e&1<<i||255^(n|t))&&(n&=t,i=a-1)}}return n}(e>>8^255)):J&&49152==(49154&e)?i=J.reg[J.idx]:!(255&~e)&&g&f?i=S:0<=o&&g&s&&(n=o/d,o%=d,n<192)&&o<124&&!(4&o)&&(a=o>>1&1|o>>2,i=w[a+=1&~o?6144&n|n<<2&224|n<<8&1792:6144|n<<2&992]),t&=i|t>>8^255,!(32770&e)&&32&~z&&(8&(z^t)&&O(o),X(t))),t},l.out=(e,r)=>{H(e);var n,a=l.time;for(n of l.devs)(e&n.omask)==n.oport&&n.out(e,r,a);if(1&~e&&(24&(_^r)&&y1(a+(r>>1&8^8)),_=r),2&~e)if(e<32768){if(32&z)return;8&(z^r)&&O(a),X(r)}else J&&(e<49152?(y1(a),x1(J.idx,r),h1(0,J.level-(J.level=z1()))):J.idx=15&r);!(255&~e)&&g&f&&(O(a),M=8191&M|(1&r)<<13,S=r,V());var i=P();I!=i&&(f1(a),I=i)},l.halt=(e,r)=>e;var C,n,U,A,L=4,E=28,F=8*(L+32+L),N=E+192+E,Y=(l.dim=[F,N],16);const G=1,P=()=>U[U==C?(7&_)<<3:0];var I=0,Q=G;function V(){if(U=C,4&S){var r=(-256|(7^(r=S>>3&7|8))<<4|r)<<16;for(let e=0;e<256;e++)n[e]=r|e<<8;U=n}}var e1=0,M=0,r1=0,n1=0;function O(e){if(!(e<e1)){var r,n,a=0,i=M,t=e1,o=r1,u=n1,f=1<<(i>>5&7|i>>8&24),c=3&S,s=c<2?(-256&i)-(i>>3&768)-6144:3^c&&-8192;do{if(c=U[w[i-s]]|w[i++],A[++o]!==c&&(A[o]=c,j(o,u,c),a|=f),c=U[w[i-s]]|w[i++],A[++o]!==c&&(A[o]=c,j(o,u,c),a|=f),t+=8,!(31&i)){if(t+=d-128,o+=2*L,u+=i1,i+=224,2&S){if(1792&i)continue;if(f<<=1,224&(i-=2016))continue}else{if(s+=256,1792&i)continue;if(s-=2048,f<<=1,224&(i-=2016))continue;s+=1792}if(6144<=(8191&(i+=1792))){t=99999;break}}}while(t<=e);M=i,e1=t,r1=o,n1=u,a&&((r=l.updated)||(l.updated=r=[N,0,0,F]),r[1]<8*L+256&&(r[1]=8*L+256),r[3]>8*L&&(r[3]=8*L),n=E+248-8*Math.clz32(a^a-1),r[0]>n&&(r[0]=n),n=E+256-8*Math.clz32(a),r[2]<n)&&(r[2]=n)}}var t,a1,R,j,i1,D,t1=0,o1=0,u1=0;function f1(e){var r=t1;if(!(e<r)){Q=G;var n=0,a=o1,i=u1,t=i1*(i+E),o=L+(L+32+L)*(E+i)+a,u=I;do{if(A[o]!==u&&(A[o]=u,j(o,t,u),n=1),o++,r+=4,!++a&&0<=i&&i<192)o+=a=32,r+=128;else if(32+L<=a){if(a=-L,++i==8*(24+E)){r=99999;break}r+=d-4*(L+32+L),t+=i1}}while(r<=e);o1=a,u1=i,t1=r,n&&(l.updated=[0,F,N,0])}}function c1(e,r,n){n<0&&(n=l1(n));var a=a1,i=R[n>>12],t=R[n>>8&15];for(e<<=3;a[e]=128&n?t:i,n<<=1,7&++e;);}function s1(e,r,n){n<0&&(n=l1(n));var a=a1,i=R[o=n>>12],t=R[u=n>>8&15]^i,o=R[o+16],u=R[16+u]^o;for(n^=n>>1&127,r+=e<<3;128&n&&(i^=t,o^=u),n<<=1,a[r]=i,a[r+F]=o,7&++r;);}function l1(e){for(var r=0,n=0;n<4;n++)r>>=1,3&e&&(r|=128),768&e&&(r|=8),e>>=2;return r|65280&e}l.get_pixels=(e,r)=>{t=new ImageData(F,e*N),(a1=new Uint32Array(t.data.buffer)).fill(255<<24),R=[[[0,11406853,198,11996364,311808,12373765,1032645,12963275,0,12065042,1316055,13708518,3008039,15268407,4781817,16777215],[0,11734533,203,12324305,313344,12702725,1099466,13292240,0,12392978,1381853,14101996,3075113,15662904,4914431,16777215,0,11144453,192,11668422,244992,12044549,965823,12568517,0,11737105,1250258,13314784,2875430,14873909,4648946,16777215]],[[0,1644824,6842471,8421246,9868948,11447724,12171703,13553100,0,2631719,7829365,10000278,12105654,14276822,15855853,16777215],[0,1710617,7039849,8618881,10132120,11776688,12500668,13947857,0,2763048,8026745,10263450,12434618,14605787,16250612,16777215,0,1579031,6645092,8158330,9605520,11119015,11842738,13224134,0,2565926,7631730,9737106,11776689,13882064,15395303,16777215]]][+r][--e].map(e=>e|-1<<24),i1=e*F,j=[c1,s1][e];for(var n=0,a=0;n<A.length;){for(var i=32+2*L;i--;n++)j(n,a,A[n]);a+=F}return l.updated=[0,F,N,0],t};var v1,d1,m1=0,p1=0,b1=0,a=[];function k1(){return a[_>>3&3]}function h1(e,r){if(D){var n=m1*r/v1,a=D.g,i=D._,t=D.S,r=(a[i]+=n,a[i=i+1&t]+=r-n,i);for(e=m1-d1*e;e<0;)e+=v1,a[i=i+1&t]=0;m1=e,(D.T-r&t)<=(i-r&t)&&(D.T=i+1&t),D._=i-1&t}}function y1(e){var r=p1,n=k1(),a=n-b1;if(b1=n,J){var i=w1;for(i||(a+=_1(J),i+=16),i+=r;i<e;)(n=_1(J))&&(h1(i-r,a),r=i,a=n),i+=16;w1=i-e}h1(e-r,a),p1=e}l.audio=e=>{(D=e)&&(d1=e.hz)},(l.volume=e=>{a=[0,.03*(e*=e),.93*e,e],J&&g1(),b1=k1()})(.5);var J,w1=0;function g1(){var e=a[3],r=J.volt,n=15;for(r[n]=e;r[--n]=e*[0,14,20,29,42,62,85,137,169,265,353,450,570,687,848][n]/1e3,1<n;);for(n=8;n<11;n++)x1(n,J.reg[n]);J.level=z1()}function x1(e,r){switch(e){case 0:J.aper=3840&J.aper|r;break;case 1:J.aper=255&J.aper|(r&=15)<<8;break;case 2:J.bper=3840&J.bper|r;break;case 3:J.bper=255&J.bper|(r&=15)<<8;break;case 4:J.cper=3840&J.cper|r;break;case 5:J.cper=255&J.cper|(r&=15)<<8;break;case 6:J.nper=r&=31;break;case 7:J.mix=~(r|J.dis);break;case 8:case 9:case 10:var n=r&=31,a=9<<e-8;r?r<16?(J.dis&=a=~a,J.ech&=a):(J.dis&=~a,J.ech|=a,n=J.estep^J.eattack):(J.dis|=a,J.ech&=~a),J.mix=~(J.reg[7]|J.dis),n=J.volt[n],e<9?J.avol=n:9<e?J.cvol=n:J.bvol=n;break;case 11:J.eper=65280&J.eper|r;break;case 12:J.eper=255&J.eper|r<<8;break;case 13:J.ekeep=1&(r=(r&=15)<8?r<4?1:7:r)?1:-1,J.ealt=r+1&2?15:0,J.eattack=4&r?15:0,J.estep=15,J.ecnt=-1,i()}J.reg[e]=r}function i(){var e,r=J.ech;r&&(e=J.volt[J.estep^J.eattack],1&r&&(J.avol=e),2&r&&(J.bvol=e),4&r)&&(J.cvol=e)}function _1(e){var r,n=0;return--e.acnt&e.aper||(e.acnt=-1,n^=1),--e.bcnt&e.bper||(e.bcnt=-1,n^=2),--e.ccnt&e.cper||(e.ccnt=-1,n^=4),(e.div16^=1)&&(--e.ncnt&e.nper||(e.ncnt=-1,1&(r=e.noise)&&(n^=56,r^=163840),e.noise=r>>1),--e.ecnt&e.eper||(e.ecnt=-1,e.ekeep&&(e.estep||(e.eattack^=e.ealt,e.ekeep>>=1,e.estep=16),e.estep--,e.ech)&&(i(),n|=256))),e.gen^=n,r=0,n&e.mix?e.level-(e.level=z1()):r}function z1(){var e=J.mix&J.gen;return(9&e?0:J.avol)+(18&e?0:J.bvol)+(36&e?0:J.cvol)}}function o5(t){var o,u,f,c,s,l,r,v,d,i,m,p,O,R,j,e,D,J,Z,q,K,W,B,X,a,b,n,k,h,y;function w(){var e=s,r=l>>8,n=c^e;return 168&f|f>>8&1|!c<<6|2&r|16&(n^l^r)|4&(256&e?154020>>(15&(c^c>>4)):(n&(l^c))>>5)}function H(e){c=64&~e,f=e|=e<<8,s=255&(l=-129&e|(4&e)<<5)}function Y(e){a=65280&a|e,b=127&e}function G(e){v=e>>8,d=255&e}function P(e){i=e>>8,m=255&e}function Q(){[v,d,i,m,p,q,K,W,B,X]=[q,K,W,B,X,v,d,i,m,p]}function V(){[u,f,c,s,l,j,e,D,J,Z]=[j,e,D,J,Z,u,f,c,s,l]}function g(e){t.time++,t.put(r-1&65535,e>>8),t.time+=3,t.put(r=r-2&65535,255&e),t.time+=3}function e1(){var e=t.get16(r);return r=r+2&65535,t.time+=6,e}function x(e){var r=(s=u)-e;l=~e,f=384&r|40&e,c=255&r}function _(e){return f=256&f|(c=e=(s=e)+(l=1)&255),e}function z(e){return f=256&f|(c=e=(s=e)+(l=-1)&255),e}function r1(e){f=256&f|(c=e),s=256|e,l=0}function n1(e){f=215&f|296&e,l&=128,s=384&s|16&c,u=255&e}function S(e,r){var n=e+r;return f=128&f|n>>8&296,s&=-17,l=128&l|16&((n^e^r)>>8^c),y=e+1,t.time+=7,65535&n}function T(){var e=t.get(o);return o=o+1&65535,t.time+=3,e}function $(){var e=t.get16(o);return o=o+2&65535,t.time+=6,e}function a1(e){s&=-17,l=128&l|16&(e>>4^c),f=256^e|128&f|40&u}function i1(){y=o=o+(128^t.get(o))-127&65535,t.time+=8}function C(e){y=$(),e&&(g(o),o=y)}function U(){y=o=t.get16(r),r=r+2&65535,t.time+=6}function t1(){h=!0;var e=t.time_limit-t.time+3>>2;0<e&&(e=t.halt(e,a|b),b=b+e&127,t.time+=4*e)}function o1(e){e:for(;;){switch(e){case 221:case 253:break;case 243:k=0;break;case 251:k=3;break;default:k1[e]();break e}var r=e;if(e=t.m1(o,a|(b=b+1&127)),o=o+1&65535,t.time+=4,4&r){var n=h1[e];if(n){n=n(221==r?O:R);null!=n&&(221==r?O=n:R=n);break}}}1&k&&0<=t.int&&t.time<t.time_limit&&u1()}function u1(){var e,r=t.int;b=b+1&127,k=0,h=!1,t.time+=6,n?(g(o),e=56,1<n&&(e=t.get16(65280&a|r),t.time+=6),y=o=e):k1[r]()}function A(e){var r=t.get(o);return o=o+1&65535,t.time+=8,y=e+(128^r)-128&65535}function L(e){var r=t.get(o);return o=o+1&65535,t.time+=8,r=t.get(y=e+(128^r)-128&65535),t.time+=3,r}function E(e,r){r=p+e+(f>>8&1^r);y=p+1,f=r>>8,s=p>>8,l=e>>8,p=r&=65535,c=r>>8|r<<8,t.time+=7}function f1(e){f=256&f|(u=e),c=+!!e,s=l=k<<6&128,t.time++}function F(){var e=v<<8|d,r=t.inp(e);return y=1+e,r1(r),t.time+=4,r}function N(e){var r=v<<8|d;y=1+r,t.out(r,e),t.time+=4}function c1(e,r){var n=p,a=t.get(n);t.time+=3,p=n+e&65535,n=i<<8|m,t.put(n,a),t.time+=5,i=(n+=e)>>8&255,m=255&n,--d<0&&(v=v-1&(d=255)),a=(s=l=v|d&&128)&&r?(t.time+=5,y=1+(o=o-2&65535),o>>8):(a+=u)<<4|8&a,f=384&f|40&a,c=c&&1}function s1(e,r){var n=p,a=t.get(n),i=u-a&255;p=n+e&65535,t.time+=8,--d<0&&(v=v-1&(d=255)),f=256&f|128&i,c=127&i|i>>7,l=~(128|a),s=127&u,v|d&&(s|=128,l|=128,r)&&i?(t.time+=5,y=1+(o=o-2&65535),f|=o>>8&40):(16&(i^a^u)&&i--,f|=i<<4&32|8&i,y=y+e&65535)}function l1(e){var r,n=e>>2,a=p+n&65535,i=v<<8|d,a=(t.time++,n=1&e?(r=t.get(p),t.time+=3,y=(i=i-256&65535)+n,t.out(i,r),t.time+=4,a):(r=t.inp(i),t.time+=4,y=i+n,i=i-256&65535,t.put(p,r),t.time+=3,i+n),p=a,7&(n=(255&n)+r)^(v=i>>8));f=v|256&n,s=128^(c=v),2&e&&v&&(t.time+=5,y=1+(o=o-2&65535),f=-41&f|o>>8&40,i=0,256&n&&v-((i=128&r?1:-1)>>1)&15&&(c^=16),a^=v-i&7),l=128&((a=4928640>>(15&(a^a>>4)))^v)|n>>4&16|r<<2&512}function v1(){u=c=255&(f=1+(l=~u)),s=0}function d1(){k|=k>>1,U()}function m1(){n=0}function p1(){n=1}function b1(){n=2}function I(e,r){switch(e){case 0:r=257*r>>7;break;case 1:r=r>>1|(1+(1&r)^1)<<7;break;case 2:r=r<<1|f>>8&1;break;case 3:r=(513*r|256&f)>>1;break;case 4:r<<=1;break;case 5:r=(513*r+128^128)>>1;break;case 6:r=r<<1|1;break;case 7:r=513*r>>1}return s=256|(c=r=255&(f=r)),l=0,r}function M(e,r){f=256&f|40&r|(r&=1<<e),s=~(c=r),l=0}o=a=b=n=k=0,r=O=R=p=X=65535,u=v=d=i=m=j=q=K=W=B=255,f=c=s=l=e=D=J=Z=y=0,h=!1,this.getState=()=>{var e={pc:o,sp:r,a:u,f:w(),bc:v<<8|d,de:i<<8|m,hl:p,ix:O,iy:R,bc_:q<<8|K,de_:W<<8|B,hl_:X,a_:j,r:128&a|b,i:a>>8,im:n,iff:k,halted:h,wz:65535&y};return V(),e.f_=w(),V(),e},this.setState=e=>{"pc"in e&&(o=e.pc),"a"in e&&(u=e.a),"f"in e&&H(e.f),"sp"in e&&(r=e.sp),"bc"in e&&G(e.bc),"de"in e&&P(e.de),"hl"in e&&(p=e.hl),"ix"in e&&(O=e.ix),"iy"in e&&(R=e.iy),Q(),V(),"bc_"in e&&G(e.bc_),"de_"in e&&P(e.de_),"hl_"in e&&(p=e.hl_),"a_"in e&&(u=e.a_),"f_"in e&&H(e.f_),Q(),V(),"r"in e&&Y(e.r),"i"in e&&(a=255&a|e.i<<8),"im"in e&&(n=3&e.im),"iff"in e&&(k=e.iff),"halted"in e&&(h=!!e.halted),"wz"in e&&(y=e.wz)},this.run=()=>{if(!(t.time>=t.time_limit)){if(1&k&&0<=t.int&&u1(),h)return t1();do{var e=t.m1(o,a|(b=b+1&127))}while(o=o+1&65535,t.time+=4,k1[e](),t.time<t.time_limit)}},this.nmi=()=>{k&=2,h=!1,g(o),t.time+=4,o=102},this.reset=()=>{h=!1,o=a=b=n=k=0};var k1=[e=>e,e=>(e=$(),v=e>>8,d=255&e),e=>(y=1+(e=v<<8|d)&255|u<<8,t.put(e,u),t.time+=3),e=>(255<++d&&(v=v+1&255,d=0),t.time+=2),e=>v=_(v),e=>v=z(v),e=>v=T(),e=>n1(257*u>>7),V,e=>p=S(p,v<<8|d),e=>(y=1+(e=v<<8|d),u=t.get(e),t.time+=3),e=>(--d<0&&(v=v-1&(d=255)),t.time+=2),e=>d=_(d),e=>d=z(d),e=>d=T(),e=>n1(u>>1|(1+(1&u)^1)<<7),e=>(t.time++,e=T(),(v=v-1&255)&&(t.time+=5,y=o=o+(128^e)-128&65535)),e=>(e=$(),i=e>>8,m=255&e),e=>(y=1+(e=i<<8|m)&255|u<<8,t.put(e,u),t.time+=3),e=>(255<++m&&(i=i+1&255,m=0),t.time+=2),e=>i=_(i),e=>i=z(i),e=>i=T(),e=>n1(u<<1|f>>8&1),i1,e=>p=S(p,i<<8|m),e=>(y=1+(e=i<<8|m),u=t.get(e),t.time+=3),e=>(--m<0&&(i=i-1&(m=255)),t.time+=2),e=>m=_(m),e=>m=z(m),e=>m=T(),e=>n1((513*u|256&f)>>1),e=>(c?i1:T)(),e=>p=$(),e=>(e=$(),t.put(e,255&p),t.time+=3,y=e+1&65535,t.put(y,p>>8),t.time+=3),e=>(p=p+1&65535,t.time+=2),e=>p=255&p|_(p>>8)<<8,e=>p=255&p|z(p>>8)<<8,e=>p=255&p|T()<<8,function(){var e=153<(u|256&f)?352:0;9<(15&u|16&(c^s^l^l>>8))&&(e+=6),s=256|u,512&l?(u-=e,l=~e):u+=l=e,f=(c=u&=255)|256&e},e=>(c?T:i1)(),e=>p=S(p,p),e=>(e=$(),y=e+1,p=t.get16(e),t.time+=6),e=>(p=p-1&65535,t.time+=2),e=>p=-256&p|_(255&p),e=>p=-256&p|z(255&p),e=>p=-256&p|T(),function(){f=384&f|40&(u^=255),l|=-129,s=384&s|16&~c},e=>(256&f?T:i1)(),e=>r=$(),e=>(e=$(),y=e+1&255|u<<8,t.put(e,u),t.time+=3),e=>(r=r+1&65535,t.time+=2),e=>(e=_(t.get(p)),t.time+=4,t.put(p,e),t.time+=3),e=>(e=z(t.get(p)),t.time+=4,t.put(p,e),t.time+=3),e=>(t.put(p,T()),t.time+=3),e=>a1(0),e=>(256&f?i1:T)(),e=>p=S(p,r),e=>(e=$(),y=e+1,u=t.get(e),t.time+=3),e=>(r=r-1&65535,t.time+=2),e=>u=_(u),e=>u=z(u),e=>u=T(),e=>a1(256&f),e=>e,e=>v=d,e=>v=i,e=>v=m,e=>v=p>>8,e=>v=255&p,e=>(v=t.get(p),t.time+=3),e=>v=u,e=>d=v,e=>e,e=>d=i,e=>d=m,e=>d=p>>8,e=>d=255&p,e=>(d=t.get(p),t.time+=3),e=>d=u,e=>i=v,e=>i=d,e=>e,e=>i=m,e=>i=p>>8,e=>i=255&p,e=>(i=t.get(p),t.time+=3),e=>i=u,e=>m=v,e=>m=d,e=>m=i,e=>e,e=>m=p>>8,e=>m=255&p,e=>(m=t.get(p),t.time+=3),e=>m=u,e=>p=255&p|v<<8,e=>p=255&p|d<<8,e=>p=255&p|i<<8,e=>p=255&p|m<<8,e=>e,e=>p=255&p|(255&p)<<8,e=>(p=255&p|t.get(p)<<8,t.time+=3),e=>p=255&p|u<<8,e=>p=-256&p|v,e=>p=-256&p|d,e=>p=-256&p|i,e=>p=-256&p|m,e=>p=-256&p|p>>8,e=>e,e=>(p=-256&p|t.get(p),t.time+=3),e=>p=-256&p|u,e=>(t.put(p,v),t.time+=3),e=>(t.put(p,d),t.time+=3),e=>(t.put(p,i),t.time+=3),e=>(t.put(p,m),t.time+=3),e=>(t.put(p,p>>8),t.time+=3),e=>(t.put(p,255&p),t.time+=3),t1,e=>(t.put(p,u),t.time+=3),e=>u=v,e=>u=d,e=>u=i,e=>u=m,e=>u=p>>8,e=>u=255&p,e=>(u=t.get(p),t.time+=3),e=>e,e=>u=c=255&(f=(s=u)+(l=v)),e=>u=c=255&(f=(s=u)+(l=d)),e=>u=c=255&(f=(s=u)+(l=i)),e=>u=c=255&(f=(s=u)+(l=m)),e=>u=c=255&(f=(s=u)+(l=p>>8)),e=>u=c=255&(f=(s=u)+(l=255&p)),e=>(u=c=255&(f=(s=u)+(l=t.get(p))),t.time+=3),e=>u=c=255&(f=2*(s=l=u)),e=>u=c=255&(f=(s=u)+(l=v)+(f>>8&1)),e=>u=c=255&(f=(s=u)+(l=d)+(f>>8&1)),e=>u=c=255&(f=(s=u)+(l=i)+(f>>8&1)),e=>u=c=255&(f=(s=u)+(l=m)+(f>>8&1)),e=>u=c=255&(f=(s=u)+(l=p>>8)+(f>>8&1)),e=>u=c=255&(f=(s=u)+(l=255&p)+(f>>8&1)),e=>(u=c=255&(f=(s=u)+(l=t.get(p))+(f>>8&1)),t.time+=3),e=>u=c=255&(f=2*(s=l=u)+(f>>8&1)),e=>u=c=255&(f=(s=u)+(l=~v)+1),e=>u=c=255&(f=(s=u)+(l=~d)+1),e=>u=c=255&(f=(s=u)+(l=~i)+1),e=>u=c=255&(f=(s=u)+(l=~m)+1),e=>u=c=255&(f=(s=u)+(l=~(p>>8))+1),e=>u=c=255&(f=(s=u)+(l=~(255&p))+1),e=>(u=c=255&(f=(s=u)+(l=~t.get(p))+1),t.time+=3),e=>(l=~(s=u),u=c=f=0),e=>u=c=255&(f=(s=u)+(l=~v)+(f>>8&1^1)),e=>u=c=255&(f=(s=u)+(l=~d)+(f>>8&1^1)),e=>u=c=255&(f=(s=u)+(l=~i)+(f>>8&1^1)),e=>u=c=255&(f=(s=u)+(l=~m)+(f>>8&1^1)),e=>u=c=255&(f=(s=u)+(l=~(p>>8))+(f>>8&1^1)),e=>u=c=255&(f=(s=u)+(l=~(255&p))+(f>>8&1^1)),e=>(u=c=255&(f=(s=u)+(l=~t.get(p))+(f>>8&1^1)),t.time+=3),e=>(l=~(s=u),u=c=255&(f=(f>>8&1^1)-1)),e=>(s=~(u=f=c=u&v),l=0),e=>(s=~(u=f=c=u&d),l=0),e=>(s=~(u=f=c=u&i),l=0),e=>(s=~(u=f=c=u&m),l=0),e=>(s=~(u=f=c=u&p>>8),l=0),e=>(s=~(u=f=c=u&p&255),l=0),e=>(s=~(u=f=c=u&t.get(p)),l=0,t.time+=3),e=>(s=~(f=c=u),l=0),e=>(s=256|(u=f=c=u^v),l=0),e=>(s=256|(u=f=c=u^d),l=0),e=>(s=256|(u=f=c=u^i),l=0),e=>(s=256|(u=f=c=u^m),l=0),e=>(s=256|(u=f=c=u^p>>8),l=0),e=>(s=256|(u=f=c=u^255&p),l=0),e=>(s=256|(u=f=c=u^t.get(p)),l=0,t.time+=3),e=>(u=f=c=l=0,s=256),e=>(s=256|(u=f=c=u|v),l=0),e=>(s=256|(u=f=c=u|d),l=0),e=>(s=256|(u=f=c=u|i),l=0),e=>(s=256|(u=f=c=u|m),l=0),e=>(s=256|(u=f=c=u|p>>8),l=0),e=>(s=256|(u=f=c=u|255&p),l=0),e=>(s=256|(u=f=c=u|t.get(p)),l=0,t.time+=3),e=>(s=256|(f=c=u),l=0),e=>x(v),e=>x(d),e=>x(i),e=>x(m),e=>x(p>>8),e=>x(255&p),e=>(x(t.get(p)),t.time+=3),e=>x(u),e=>(t.time++,c&&U()),e=>(e=e1(),v=e>>8,d=255&e),e=>(y=$(),c&&(o=y)),e=>y=o=$(),e=>C(c),e=>g(v<<8|d),e=>u=c=255&(f=(s=u)+(l=T())),e=>(g(o),y=o=0),e=>(t.time++,!c&&U()),U,e=>(y=$(),!c&&(o=y)),function(){var e=t.m1(o,a|(b=b+1&127)),r=(o=o+1&65535,t.time+=4,7&(n=e>>3)),n=8&n|7&e;e<128?w1[n](r):g1[n](1<<r)},e=>C(!c),e=>(e=$(),g(o),y=o=e),e=>u=c=255&(f=(s=u)+(l=T())+(f>>8&1)),e=>(g(o),y=o=8),e=>(t.time++,!(256&f)&&U()),e=>(e=e1(),i=e>>8,m=255&e),e=>(y=$(),!(256&f)&&(o=y)),e=>(e=T()|u<<8,t.out(e,u),y=1+e&255|65280&e,t.time+=4),e=>C(!(256&f)),e=>g(i<<8|m),e=>u=c=255&(f=(s=u)+(l=~T())+1),e=>(g(o),y=o=16),e=>(t.time++,256&f&&U()),Q,e=>(y=$(),256&f&&(o=y)),e=>(e=T()|u<<8,u=t.inp(e),y=1+e,t.time+=4),e=>C(256&f),e=>o1(221),e=>u=c=255&(f=(s=u)+(l=~T())+(f>>8&1^1)),e=>(g(o),y=o=24),e=>(t.time++,4&~w()&&U()),e=>p=e1(),e=>(y=$(),4&~w()&&(o=y)),e=>(y=e1(),g(p),p=y,t.time+=2),e=>C(4&~w()),e=>g(p),e=>(s=~(u=f=c=u&T()),l=0),e=>(g(o),y=o=32),e=>(t.time++,4&w()&&U()),e=>o=p,e=>(y=$(),4&w()&&(o=y)),e=>(e=p,p=i<<8|m,i=e>>8,m=255&e),e=>C(4&w()),function(){var e=y1[t.m1(o,a|(b=b+1&127))];o=o+1&65535,t.time+=4,e&&e()},e=>(s=256|(u=f=c=u^T()),l=0),e=>(g(o),y=o=40),e=>(t.time++,128&~f&&U()),e=>{var r;H(255&(r=e1())),u=r>>8},e=>(y=$(),128&~f&&(o=y)),e=>o1(243),e=>C(128&~f),e=>g(u<<8|w()),e=>(s=256|(u=f=c=u|T()),l=0),e=>(g(o),y=o=48),e=>(t.time++,128&f&&U()),e=>(r=p,t.time+=2),e=>(y=$(),128&f&&(o=y)),e=>o1(251),e=>C(128&f),e=>o1(253),e=>x(T()),e=>(g(o),y=o=56)],h1=[,,,,,,,,,e=>S(e,v<<8|d),,,,,,,,,,,,,,,,e=>S(e,i<<8|m),,,,,,,,$,e=>{y=$(),t.put(y,255&e),t.time+=3,y=y+1&65535,t.put(y,e>>8),t.time+=3},e=>(t.time+=2,e+1&65535),e=>255&e|_(e>>8)<<8,e=>255&e|z(e>>8)<<8,e=>255&e|T()<<8,,,e=>S(e,e),e=>(e=$(),y=e+1,e=t.get16(e),t.time+=6,e),e=>(t.time+=2,e-1&65535),e=>-256&e|_(255&e),e=>-256&e|z(255&e),e=>-256&e|T(),,,,,,(e,r)=>{e=A(e),r=_(t.get(e)),t.time+=4,t.put(e,r),t.time+=3},(e,r)=>{e=A(e),r=z(t.get(e)),t.time+=4,t.put(e,r),t.time+=3},(e,r)=>{e=A(e),t.time-=5,r=T(),t.time+=2,t.put(e,r),t.time+=3},,,e=>S(e,r),,,,,,,,,,,e=>{v=e>>8},e=>{v=255&e},e=>{v=L(e)},,,,,,e=>{d=e>>8},e=>{d=255&e},e=>{d=L(e)},,,,,,e=>{i=e>>8},e=>{i=255&e},e=>{i=L(e)},,,,,,e=>{m=e>>8},e=>{m=255&e},e=>{m=L(e)},,e=>255&e|v<<8,e=>255&e|d<<8,e=>255&e|i<<8,e=>255&e|m<<8,,e=>255&e|(255&e)<<8,e=>{p=255&p|L(e)<<8},e=>255&e|u<<8,e=>-256&e|v,e=>-256&e|d,e=>-256&e|i,e=>-256&e|m,e=>-256&e|e>>8,,e=>{p=-256&p|L(e)},e=>-256&e|u,e=>{t.put(A(e),v),t.time+=3},e=>{t.put(A(e),d),t.time+=3},e=>{t.put(A(e),i),t.time+=3},e=>{t.put(A(e),m),t.time+=3},e=>{t.put(A(e),p>>8),t.time+=3},e=>{t.put(A(e),255&p),t.time+=3},,e=>{t.put(A(e),u),t.time+=3},,,,,e=>{u=e>>8},e=>{u=255&e},e=>{u=L(e)},,,,,,e=>{u=c=255&(f=(s=u)+(l=e>>8))},e=>{u=c=255&(f=(s=u)+(l=255&e))},e=>{u=c=255&(f=(s=u)+(l=L(e)))},,,,,,e=>{u=c=255&(f=(s=u)+(l=e>>8)+(f>>8&1))},e=>{u=c=255&(f=(s=u)+(l=255&e)+(f>>8&1))},e=>{u=c=255&(f=(s=u)+(l=L(e))+(f>>8&1))},,,,,,e=>{u=c=255&(f=(s=u)+(l=~(e>>8))+1)},e=>{u=c=255&(f=(s=u)+(l=~(255&e))+1)},e=>{u=c=255&(f=(s=u)+(l=~L(e))+1)},,,,,,e=>{u=c=255&(f=(s=u)+(l=~(e>>8))+(f>>8&1^1))},e=>{u=c=255&(f=(s=u)+(l=~(255&e))+(f>>8&1^1))},e=>{u=c=255&(f=(s=u)+(l=~L(e))+(f>>8&1^1))},,,,,,e=>{s=~(u=f=c=u&e>>8),l=0},e=>{s=~(u=f=c=u&e&255),l=0},e=>{s=~(u=f=c=u&L(e)),l=0},,,,,,e=>{s=256|(u=f=c=u^e>>8),l=0},e=>{s=256|(u=f=c=u^255&e),l=0},e=>{s=256|(u=f=c=u^L(e)),l=0},,,,,,e=>{s=256|(u=f=c=u|e>>8),l=0},e=>{s=256|(u=f=c=u|255&e),l=0},e=>{s=256|(u=f=c=u|L(e)),l=0},,,,,,e=>{x(e>>8)},e=>{x(255&e)},e=>{x(L(e))},,,,,,,,,,,,,function(e){var r=y=e+(128^t.get(o))-128&65535,e=(t.time+=3,t.get(o+1&65535)),n=(o=o+2&65535,t.time+=5,t.get(r)),a=(t.time+=4,e>>3&7);switch(192&e){case 0:n=I(a,n);break;case 64:return M(a,n),void(f=384&f|r>>8&40);case 128:n&=~(1<<a);break;case 192:n|=1<<a}switch(t.put(r,n),t.time+=3,7&e){case 0:v=n;break;case 1:d=n;break;case 2:i=n;break;case 3:m=n;break;case 4:p=255&p|n<<8;break;case 5:p=65280&p|n;break;case 7:u=n}},,,,,,,,,,,,,,,,,,,,,,e1,,e=>(y=e1(),g(e),t.time+=2,y),,g,,,,e=>o=e,,,,,,,,,,,,,,,,e=>(t.time+=2,r=e)],y1=[,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,e=>v=F(),e=>N(v),e=>E(~(v<<8|d),1),e=>(e=$(),t.put(e,d),t.time+=3,y=e+1&65535,t.put(y,v),t.time+=3),v1,d1,m1,e=>(a=255&a|u<<8,t.time++),e=>d=F(),e=>N(d),e=>E(v<<8|d,0),e=>(e=$(),y=e+1,e=t.get16(e),v=e>>8,d=255&e,t.time+=6),v1,d1,m1,e=>(Y(u),t.time++),e=>i=F(),e=>N(i),e=>E(~(i<<8|m),1),e=>(e=$(),t.put(e,m),t.time+=3,y=e+1&65535,t.put(y,i),t.time+=3),v1,d1,p1,e=>f1(a>>8),e=>m=F(),e=>N(m),e=>E(i<<8|m,0),e=>(e=$(),y=e+1,e=t.get16(e),i=e>>8,m=255&e,t.time+=6),v1,d1,b1,e=>f1(128&a|b),e=>p=255&p|F()<<8,e=>N(p>>8),e=>E(~p,1),e=>(e=$(),t.put(e,255&p),t.time+=3,y=e+1&65535,t.put(y,p>>8),t.time+=3),v1,d1,m1,function(){var e=t.get(p)|u<<8;t.time+=7,r1(u=240&u|15&e),t.put(p,e>>4&255),y=p+1,t.time+=3},e=>p=-256&p|F(),e=>N(255&p),e=>E(p,0),e=>(e=$(),y=e+1,e=t.get16(e),p=e,t.time+=6),v1,d1,m1,function(){var e=t.get(p)<<4|15&u;t.time+=7,r1(u=240&u|e>>8),t.put(p,255&e),y=p+1,t.time+=3},F,e=>N(0),e=>E(~r,1),e=>(e=$(),t.put(e,255&r),t.time+=3,y=e+1&65535,t.put(y,r>>8),t.time+=3),v1,d1,p1,,e=>u=F(),e=>N(u),e=>E(r,0),e=>(e=$(),y=e+1,e=t.get16(e),r=e,t.time+=6),v1,d1,b1,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,e=>c1(1,0),e=>s1(1,0),e=>l1(4),e=>l1(5),,,,,e=>c1(-1,0),e=>s1(-1,0),e=>l1(-4),e=>l1(-3),,,,,e=>c1(1,1),e=>s1(1,1),e=>l1(6),e=>l1(7),,,,,e=>c1(-1,1),e=>s1(-1,1),e=>l1(-2),e=>l1(-1)],w1=[e=>v=I(e,v),e=>d=I(e,d),e=>i=I(e,i),e=>m=I(e,m),e=>p=255&p|I(e,p>>8)<<8,e=>p=-256&p|I(e,255&p),e=>(e=I(e,t.get(p)),t.time+=4,t.put(p,e),t.time+=3),e=>u=I(e,u),e=>M(e,v),e=>M(e,d),e=>M(e,i),e=>M(e,m),e=>M(e,p>>8),e=>M(e,255&p),e=>(M(e,t.get(p)),f=384&f|y>>8&40,t.time+=4),e=>M(e,u)],g1=[e=>v&=~e,e=>d&=~e,e=>i&=~e,e=>m&=~e,e=>p&=~(e<<8),e=>p&=~e,e=>(e=t.get(p)&~e,t.time+=4,t.put(p,e),t.time+=3),e=>u&=~e,e=>v|=e,e=>d|=e,e=>i|=e,e=>m|=e,e=>p|=e<<8,e=>p|=e,e=>(e|=t.get(p),t.time+=4,t.put(p,e),t.time+=3),e=>u|=e]}f((e,r)=>{e=e("L3RvcmluYWsu"),(!r||r.href.indexOf(e)<0)&&emu.stop(e,1)},1e6,atob,h("a[rel=author]")),ui={msg:W},top!=self&&(h("body").className="embed",ui.embed=!0),emu=(t=["load"],(S={}).init=()=>{z=S.zx;try{var e=z.audio;try{var r=new AudioContext}catch(e){throw"No audio"}var n=r.createScriptProcessor(2048,0,1),a=(n.connect(r.destination),{hz:r.sampleRate,g:new Float32Array(8192),T:0,_:0,S:8191});n.onaudioprocess=(d=v=0,i=(l=a).hz,m=Math.pow(2,-5e3/i),p=Math.pow(2,-35e5/23256/i),e=>{emu.$=S1;var r,n=e.outputBuffer.getChannelData(0),a=l.g,i=l.T,t=l.S,e=n.length,o=l._-i&t,u=e<o?e:o,f=v,c=d,s=0;if(0<u)for(;r=f+a[i],i=i+1&t,n[s++]=c=p*(c+r-(f=m*r)),--u;);if(l.T=i,0<(u=e-o)&&(c||f))for(;r=f,n[s++]=c=p*(c+r-(f*=m)),--u;);d=c,v=f}),console.log(n),e(a),emu.m=()=>{emu.m=null,r.resume()},S.C=1}catch(e){ui.msg(e)}var l,v,d,i,m,p;!function r(n){requestAnimationFrame(e=>{if(t.length)y1();else{if(e<n)return r(n);e<n+20?e=n:e<n+40&&(h1(0),e=n+20),h1(2)}r(e+20)})}()},S.getState=e=>{e=z.getState(e);return e.speed=n,e.kj=k1(),e.bw=a,e},S.setState=e=>{z.setState(e),n=+e.speed||n;var r=e.bw;r!=S1&&(r=+!!r)!=a&&(a=r,X=z.get_pixels(i,a)),k1(e.kj)},b=[],S.kbd=(e,r,n)=>{if(e==S1||e===+e)if(z.keyboard.fill(255),e!=(k=S1)){var a=e,i=r,t=n;if(z.keyboard,p!=S1){r={39:1,37:2,40:4,38:8,17:16,9:128}[~a];if(r&&(p&=~r,i))return void(p|=r)}var o,u=[,,,18247,,,,,17476,20303,,,,1542,,,0,3855,3855,,,,,,,,,17219,,,,,1799,,,,17219,25443,23644,21588,25700,,,,,,,,1028,771,2827,4883,6939,8995,9252,7196,5140,3084,,34957,39578,38542,41634,39064,35723,257,10023,6168,4369,4626,6425,8481,9766,5397,7710,5654,3598,5911,7967,3341,1285,514,6682,2313,8738,7453,8224,2570,4112,9509,2056,0,3855,,,,,,,,,,,,,,42919,38550,,40606,38807,41120,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,42662,,34181,37779,39835,41891,42148,33924,38036,35980,42919,38550,,33950,,,,,,,,,,,,,34957,38542,39583,33950,41623,39072,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,34204];if(a<0&&!(~a in u))return 1;for(let e=0;;e++){var f=b[e];if(f==S1){i&&(b[e]=a);break}if(f==a){i||b.splice(e,1);break}}for(o of b){if(o<0){if((o=u[~o])==S1)continue;1&t&&(o>>=8)}b1(o)}}else b=[];else c=e,l=z.keyboard,m=d=v=0,k=()=>{if(!v){if(s=d,d=0,!s){if(m==c.length)return void(k=null);var e=1+"aq10p\n zsw29ol xde38ikmcfr47ujnvgt56yhb AQ  P  ZSW  OL XDE  IKMCFR  UJNVGT  YHB  \u2264!_\"  : \u2260@);= \xa3 \u2265#( +.? <$' -,/ >%& ^* ~   \xa9   |       \\       {   ]   }   [".indexOf(c[m++]);if(!e)return;s=e%40,s|=(e=e/40|0)<<6,3==e&&(d=s-64,s=79)}b1(s),v=5}3==--v&&l.fill(255)};var c,s,l,v,d,m},B={imask:255,iport:31,inp:e=>p},S.stop=(e,r)=>{var n=t.indexOf(e);if(r)n<0&&t.push(e);else{if(r==S1)return 0<=n;n<0||t.splice(n,1)}},a=!(n=1),S.canvas=(e,r)=>{H=e.getContext("2d",{alpha:!1,desynchronized:!0});var n=z.dim,r=1+(r>=2*n[1]);r!=i&&(i=r,e.width=n[0],e.height=r*n[1]),X=z.get_pixels(r,a),H.putImageData(X,0,0)},S.reset=()=>{z.setState({rom:null,ay:""}),z.reset()},Y={},S.load=(d,e,m)=>{"string"==typeof e?e={url:e}:v.File&&e instanceof File&&(e={file:e}),"tape"==d&&w();var p,b,k,h,y=m1(e,{},e=>{if(!k){if(e.type&&g(p=x1(e.type)),!e.data)return g1(d);if(p||g(p=x1(e.name||e.url,1)),"rom"==p||"sna"==p||"z80"==p||"scr"==p)g(p),S.stop("snap",1),b={ram:(b=z.getState(2)).ram},k=function(s,o,e){o.pos|=0;var r={sna:function*(){var e,n=yield[,0,27];m(),p(n,{bc:13,de:11,hl:9,ix:17,iy:15,bc_:5,de_:3,hl_:1,a:22,f:21,a_:8,f_:7,sp:23,i:0,r:20}),s.im=n[25],s.iff=4&n[19]?3:0,s.border=7&n[26],64&n[26]&&(s.ay=!0);for(e of[5,2,0])yield*a(e);if(yield v){let{sp:e,ram:r}=s;n=e=>[[],r[5],r[2],r[0]][e>>14][16383&e];s.pc=n(e++)|n(e++)<<8,s.sp=65535&e}else{s.pc=(yield)|(yield)<<8;var n=yield,r=(yield,s.model=T1,s.ay=!0,7&(s.p7FFD=n));r&&(n=s.ram,[n[0],n[r]]=[n[r],n[0]]);for(let e=0;e<8;e++)2!=e&&5!=e&&e!=r&&(yield*a(e))}function*a(e){yield[s.ram[e],0,16384]}},z80:function*(){var n=yield[,0,30],a=(m(),p(n,{a:0,f:1,bc:2,hl:4,pc:6,sp:8,i:10,de:13,bc_:15,de_:17,hl_:19,a_:21,f_:22,iy:23,ix:25}),n[12]),i=n[29],t=127&n[11]|(a=255==a?1:a)<<7&128,e=(s.border=a>>1&7,n[28]);if(s.halted=118==e,s.iff=!!n[27]|!!e<<1,s.im=3&n[29],i>>6==1&&(s.joy=!0),s.pc){e=$1(49152);s.ram=e,32&a?(yield*c(e,49152),(yield v)||(yield[,0,4])):yield[e,0,49152]}else{n=(yield)|(yield)<<8,i=yield[,0,n];p(i,{pc:0});let e=i[2],r=(n<24&&(e+=2<e&&e<5),[x,x,x,x,T1,T1,T1,T1,T1,M,M,x,T1,T1,_,_][e]);r==S1&&(r=T1),z1(s.model=r)&&(s.p7FFD=i[3]),r==_&&(s.pFF=i[4]);a=i[5];1&~a&&(t=128&t|128*Math.random()),4&a&&(s.ay={idx:i[4],reg:i.slice(7,23)});do{var o=(yield)|(yield)<<8,u=yield;if(!(o|u))return;var f=[[,2,0,,,5],[0,1,2,3,4,5,6,7]][z1(r)][u-3];let e;if(f==+f)e=s.ram[f];else{if(!(u<2)){yield[,0,o];continue}e=$1(16384),s.rom=e}o<65535?yield*c(e,16384,o):yield[e,0,16384]}while(!(yield v))}function*c(r,n,a=1e9){for(var i=0;i<n;){if(!a--)throw"Z80: underrun";let e=yield;if(237==e&&2<a){if(a--,237==(e=yield)){var t=i;if(n<(i+=yield))throw"Z80: overflow";r.fill(yield,t,i),a-=2;continue}r[i++]=237}r[i++]=e}if(a&&a<1e8)throw"Z80: garbage"}s.r=t},rom:function*(){for(var e=$1(16384),r=0;e[r++]=yield,!(yield v);)if(16383<r)throw"Too long";for(;r&r-1;)e[r++]=255;for(;r<16384;)e.set(e.slice(0,r),r),r+=r;s.pFF=s.halted=s.pc=s.im=s.iff=0,s.p7FFD=48,s.rom=e},scr:function*(){m();var e=s.ram[5];e.fill(0,6912,16380),e.set([243,118,24,252],16380),s.pc=32764,s.halted=1,s.iff=0,s.model=x;let r=7;yield[e,0,6144],(yield v)?e.fill(56,6144,6912):(yield[e,6144,6912],r=0,(yield v)||(r=yield,yield v)||(e.set(e.slice(6144,6912),8192),e[8960]=r,s.model=_,s.pFF=2,yield[e,8961,14336],r=0,yield v)||(s.pFF=yield)),s.border=7&r}};if(!(e in r))throw e+": Unknown format";var u,f,c,l=r[e]();const v=1;return d(),()=>{for(var{pos:r,data:n,eof:e}=o,a=n.length;r<a;){if(!l)return void n.length;let e;if(u)if(u<0)e=!1;else{var i=a-r,t=c-f;if(i<t){u.set(n.slice(r),f),r+=i,f+=i;break}u.set(n.slice(r,r+t),f),r+=t,e=u}else e=n[r++];d(e)}if(o.pos=r,e)for(;l;){if(!(u<0))throw"Truncated";d(!0)}};function d(e){u=S1;var r,{value:e,done:n}=l.next(e);n?l=S1:e&&(e==v?u=-1:([n,e,r]=e,u=n||new Uint8Array(r),f=e,c=r))}function m(){s.model=x,s.pFF=s.halted=0,s.p7FFD=48,s.rom=S1,s.ay=!1}function p(e,r){for(var n in r){var a=r[n];s[n]=e[a],n.match(/.[a-z]/)&&(s[n]|=e[a+1]<<8)}}}(b,e,p),h=()=>setTimeout(()=>S.stop("snap",0),200);else{if("tap"!=p)throw"Unknown file type";if("snap"==d){g1(d="tape",y,1),p=(p=(p=(p=e.type)&&p.match(/; *model *= *([^ ]+)/))&&_1(p[1]))||z.getState().model;var r=z,n=p,a=16384,i=[,$1(a),$1(a),$1(a)];function t(e,r){i[e>>14][16383&e]=255&r}function o(e,r){t(e,r),t(e+1,r>>8)}function u(e,r,n,a){for(;0<a--;)t(e++,r[n++])}for(var f=r.v[0],c={ram:[i[3],,i[2],,,i[1]],model:n,i:63,border:7,rom:S1,ay:"",iy:23610,im:1,iff:3},s=16384;s<22528;)t(s++,0);for(;s<23296;)t(s++,56);for(;s<65536;)t(s++,0);o(23732,--s),u(s-=167,f,15880,168),o(23675,s--),t(23608,64),o(23730,s),o(23606,15360),t(s--,62),o(23613,(c.sp=s)-2),o(23631,23734),u(23734,f,5551,21),s=23754,o(23639,s++),o(23635,s),o(23627,s),t(s++,128),o(23641,s);for(var l=0;l<'\xef""'.length;l++)t(s++,'\xef""'.charCodeAt(l));o(s,32781),o(23649,s+=2),o(23651,s),o(23653,s),t(23693,56),t(23695,56),t(23624,56),o(23561,1315),t(23552,255),t(23556,255),u(23568,f,5574,14),o(23688,6177),t(23659,2),o(23656,23698),t(23611,12),c.pc=4788,z1(n)&&(u(23296,r.h,107,88),t(23389,207),o(23427,60396),o(23429,11244),t(23431,1),(f=c.ram[7]=$1(a))[s=11254]=f[s+2]=0,f[s+1]=192,f[11285]=20,f[14067]=20,f[15723]=5,f[(s=11279)-1]=255,f[s]=f[s+2]=56,o(c.sp,6932),o(23425,s=23539),u(s,[231,63,43,39,231,63,122,38,49,13,103,38],0,12),c.p7FFD=0,c.pc=619),t(23672,s=32768*Math.random()|0),c.r=s>>8,r.setState(c),g1("snap"),w()}}}if(k)try{var v=1;e.data&&k(),v=e.eof}finally{v&&(g1(d),h)&&h(),b&&(z.setState(b),m)&&m(b)}});function w(){S.tape={data:e.data,pos:0},k=()=>S.tape.data=e.data,h=()=>S.tape.eof=1}function g(e){d1({tap:"#0C3",rom:"#D04"}[e]||"#06F")}g1(d,y,1)},S.getType=x1,S),d=location,s=u.body,g=ui.embed,T=h("#s"),G={e:h("#l"),w:256},P={e:h("#r"),w:272},Q="application/json",ui.init=()=>{(onresize=A1)(),onclick=onchange=L1,onmousedown=onmousemove=onmouseout=onmouseup=ondragenter=ondragover=ondragleave=E1,s.ontouchstart=s.ontouchmove=s.ontouchend=O1,onkeydown=onkeyup=F1,addEventListener("focus",N1,1),addEventListener("blur",N1,1),h("#c").oncopy=ondragstart=ondrag=ondragend=M1,u.onpaste=ondrop=I1,g||(m=localStorage,e=function(){try{var n="qaop-state",e=m[n];if(e){m.removeItem(n);var r=JSON.parse(e.slice(1<<17));r.ram=[];for(var a=0;a<8;a++){var i=$1(16384);r.ram[a]=i;for(var t=0;t<16384;t++)i[t]=e.charCodeAt(a<<14|t)}}}catch(e){ui.msg(e)}return onpagehide=()=>{var e=emu.getState(),r=e.ram;delete e.ram,e.pause=emu.stop("user"),e.volume=A,e.mute=U,m[n]=r.reduce((e,r)=>e+String.fromCharCode(...r),"")+JSON.stringify(e)},r}())||f(()=>ui.msg("F9 - menu",5e3),300),(r=j1(g)||{})["!"]&&(e={iff:0,halted:1,kj:(e=e||{}).kj,volume:e.volume});var e,r,n,a=0,i=(g||(e&&(emu.stop("user")^e.pause&&ui.cmd("pause"),N(e)),P1(h(".tabv>:last-child")),a=r.snaps<<1|!!r.u<<1|r.menu,ui.show(3,3)),onhashchange=()=>{D1(j1()),Z1()},f(()=>{e||(r.reset=1),D1(r),emu.stop("load",0)}),f(()=>ui.show(3,a)),(r.snaps||r.menu)&&J1(/./),"files"in h("input[type=file]")),t=emu.C;I(s,t?"+audio":"+noaudio");for(n of J("[data-c]"+(i?"":":not([data-c=open)")+(t?",#vol":":not([data-c=mute])")))n.disabled=0;T.ondblclick=()=>ui.cmd("pause"),T.draggable=!0,g||((onstorage=q1)(),W1()),s.removeChild(h("#sp"));var o,i=v.applicationCache;i&&(o=i,h("h1").onclick=()=>ui.cmd("update"),o.onupdateready=()=>{u1=1,o.swapCache(),I(s,"+update")}),onmessage=e=>{var r,n,a=e.data;if(a===a+""?(e=(n=a).match(/^([^ ]+) ([^ ]+)/))&&([,n,r]=e,r==(e=+r))&&(r=e):n=a.cmd,n)switch(n){case"load":(r=r||a)&&ui.load(r);break;case"model":r!=S1&&N({model:r});break;case"keydn":case"keyup":r&&emu.kbd(+r,"keydn"==n);break;default:ui.cmd(n,r)}else N(a)},C1({volume:A})},U=C=!1,A=.5,ui.cmd=(e,r)=>{var n,a,i,t,o=r==S1,u=emu.getState();switch(e){case"ay":case"bw":case"kj":o&&(r=!u[e]),(n={})[e]=+r;break;case"pause":o&&(r=!emu.stop("user")),C=!!r,emu.stop("user",r),U1(),C1({pause:C}),function i(){var e=h("link[rel~=icon]");return s1?(e.href=s1[+!!emu.stop("user")],0):void p1(e.href,(e,r,n)=>{var a=e.canvas;s1=[a.toDataURL()],e.scale(r/16,n/16),e.fillStyle="#FFF",e.fillRect(9,9,7,7),e.fillStyle="#33C",e.fillRect(10,10,2,5),e.fillRect(13,10,2,5),s1[1]=a.toDataURL(),i()})}(),r&&emu.kbd();break;case"reset":emu.reset(),J1();break;case"open":var f=h("#open");f.onchange=()=>{var e=f.files[0];e&&ui.load(e),f.value="",J1()},f.click();break;case"save":try{/\.z80$/i.test(r=r||"snapshot")||(r+=".z80"),K1(r,H1())}catch(e){ui.msg(e)}break;case"128":r=r?T1:x;case"model":n={model:r=o?z1(u.model)?x:T1:r};break;case"mute":n={mute:+(r=o?!U:r)};break;case"remember":!function(){for(var e=X1(),r=F.snaps,n=0,a=e;;){var i=r.o.indexOf(a);if(i<0||i==r.sel)break;a=`${e} (${++n})`}i=r.sel;try{0<=i&&m.removeItem("zx/"+r.o[i]),m["zx/"+a]=H1()}catch(e){return ui.msg(e)}i<0?(i=r5(r,a,a),I(r.e[i],"+sel")):r.e[i].firstChild.textContent=r.o[i]=a,r.act("sel",r.sel=i),W1()}();break;case"restore":s().act("click",t.sel);break;case"rmsna":s().act("del",t.sel);break;case"svsna":m&&(a=s().o[t.sel],(i=m["zx/"+a]).match(/^data:/))&&K1(a+".z80",i);break;case"update":var c=v.applicationCache;if(c&&!u1)switch(c.status){case 1:c.update();case 2:case 3:return}J1(/./),d.reload();break;case"help":h("[rel=help]").click()}function s(){return t=F.snaps}n&&N(n)},ui.load=(e,r)=>{r||J1(),emu.load("snap",e,U1)},ui.show=(e,r)=>{g&&(r&=-4);e=$&~e^r;return e!=$&&(3&($^e)&&I(s,"anim",null!=$),I(s,"full",!(3&e)),$=e,A1(),h("#c")[3&e?"blur":"focus"]()),e},o1=[],L=$1(40),l1={},onappinstalled=()=>ui.msg("Installed"),E={},F={snaps:{ul:h("#snaps")},user:{ul:h("#userg")}},addEventListener("transitionend",()=>I(s,"-anim")),onerror=(...e)=>ui.msg(e[4]),p1(l+"rom.img",(e,r,n)=>{for(var a=e.getImageData(0,0,r,n).data,i=a.length/4,t=$1(i),o=0;o<i;o++)t[o]=a[4*o];for(var u=[],o=0;o<i;o+=16384)u.push(t.slice(o,o+16384));e=new t5(o5);e.v=[u[0],u[1],u[2],u[1]],e.h=u[3],(emu.zx=e).init(),emu.init(),ui.init(),h("body").style.cursor=""})})(document);